<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  판매 정보(Sales) MyBatis Mapper XML
  - 판매 정보 관련 모든 SQL 쿼리를 정의
  - namespace는 연결할 Mapper 인터페이스의 전체 경로(패키지명 포함)
-->
<mapper namespace="com.green.car_info_backend.sales.mapper.SaleMapper">
    
    <!--
      ResultMap: sale
      - SQL 쿼리 결과를 SaleDTO 객체로 매핑하는 규칙 정의
      - <id>: Primary Key 컬럼 매핑
      - <result>: 일반 컬럼 매핑
      - <association>: 연관된 객체(CarDTO) 매핑
    -->
    <resultMap id="sale" type="com.green.car_info_backend.sales.dto.SaleDTO">
        <!-- Primary Key: 판매 번호 -->
        <id     column="SELL_NUM" property="sellNum"/>
        
        <!-- 판매 정보 기본 컬럼들 -->
        <result column="CUS_NAME" property="cusName"/>      <!-- 고객명 -->
        <result column="CUS_PHONE" property="cusPhone"/>    <!-- 고객 전화번호 -->
        <result column="COLOR" property="color"/>           <!-- 차량 색상 -->
        <result column="SELL_DATE" property="sellDate"/>    <!-- 판매일자 -->
        <result column="MODEL_NUM" property="modelNum"/>    <!-- 차량 모델 번호(FK) -->
        
        <!--
          연관 객체 매핑: CarDTO
          - SaleDTO 내부의 carDTO 필드에 차량 정보를 매핑
          - CarMapper의 resultMap을 재사용하여 중복 코드 방지
        -->
        <association property="carDTO" resultMap="com.green.car_info_backend.car.mapper.CarMapper.car"/>
    </resultMap>

    <!--
      판매정보 등록 쿼리
      - id: Mapper 인터페이스의 메서드명과 일치해야 함
      - parameterType: 생략 가능 (자동으로 SaleDTO로 인식)
      
      실행 흐름:
      1. 클라이언트 -> Controller -> Service -> Mapper 호출
      2. 이 INSERT 쿼리가 실행됨
      3. SELL_NUM(PK)는 자동 증가로 자동 생성
      4. SELL_DATE는 DB의 기본값(CURRENT_TIMESTAMP)으로 자동 설정
      
      주의사항:
      - MODEL_NUM은 CAR_INFO 테이블에 존재하는 값이어야 함 (외래키 제약조건)
      - 필수 컬럼: CUS_NAME, COLOR, MODEL_NUM, CUS_PHONE
    -->
    <insert id="addSale">
        INSERT INTO sales_info (
            CUS_NAME        -- 고객명 (필수)
            , COLOR         -- 차량 색상 (필수)
            , MODEL_NUM     -- 차량 모델 번호 (필수, CAR_INFO 테이블 참조)
            , CUS_PHONE     -- 고객 전화번호 (필수)
        ) VALUES (
            #{cusName}      -- SaleDTO의 cusName 필드 값
            , #{color}      -- SaleDTO의 color 필드 값
            , #{modelNum}   -- SaleDTO의 modelNum 필드 값
            , #{cusPhone}   -- SaleDTO의 cusPhone 필드 값
        )
        <!-- 
          참고: #{변수명} 형식은 PreparedStatement의 ?와 동일
          - SQL Injection 공격 방지
          - 자동으로 타입 변환 수행
        -->
    </insert>

    <!--
      판매정보 조회 쿼리 (차량 정보 포함)
      - resultMap: 위에서 정의한 "sale" resultMap 사용
      - JOIN을 통해 판매 정보와 차량 정보를 한 번에 조회
      
      쿼리 설명:
      1. SALES_INFO(s)와 CAR_INFO(c) 테이블을 INNER JOIN
      2. MODEL_NUM을 기준으로 연결 (판매된 차량의 상세 정보 가져오기)
      3. SELL_DATE 기준 내림차순 정렬 (최신 판매 정보가 먼저 조회됨)
      
      반환 데이터 구조:
      - List<SaleDTO> 형태로 반환
      - 각 SaleDTO는 판매 정보 + carDTO(차량 정보) 포함
    -->
    <select id="getSaleList" resultMap="sale">
        SELECT s.SELL_NUM          -- 판매 번호
            , s.CUS_NAME           -- 고객명
            , s.CUS_PHONE          -- 고객 전화번호
            , s.COLOR              -- 차량 색상
            , s.SELL_DATE          -- 판매일자
            , s.MODEL_NUM          -- 차량 모델 번호
            , c.MODEL_NAME         -- 차량 모델명 (JOIN을 통해 가져옴)
            , c.MODEL_PRICE        -- 차량 가격 (JOIN을 통해 가져옴)
            , c.MADE_COMPANY       -- 제조사 (JOIN을 통해 가져옴)
        FROM SALES_INFO s          -- 판매 정보 테이블 (별칭: s)
        JOIN CAR_INFO c            -- 차량 정보 테이블 (별칭: c)
            ON s.MODEL_NUM = c.MODEL_NUM  -- 조인 조건: 모델 번호로 연결
        ORDER BY s.SELL_DATE DESC  -- 정렬: 판매일자 기준 최신순
        <!--
          성능 최적화 팁:
          - MODEL_NUM에 인덱스가 설정되어 있어야 JOIN 성능이 향상됨
          - SELL_DATE에도 인덱스 설정 권장 (정렬 성능 향상)
        -->
    </select>

</mapper>
